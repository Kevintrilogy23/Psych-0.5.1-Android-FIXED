name: Build Android (FNF / Psych Engine)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  buildAndroid:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
    # =========================
    # Checkout
    # =========================
    - name: Checkout repository
      uses: actions/checkout@v4

    # =========================
    # Java (Gradle / Android)
    # =========================
    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 11

    # =========================
    # Android SDK
    # =========================
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # =========================
    # Android NDK (compatível Lime/OpenFL)
    # =========================
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r21e

    # =========================
    # Haxe
    # =========================
    - name: Setup Haxe
      uses: krdlab/setup-haxe@v1
      with:
        haxe-version: 4.2.5

    # =========================
    # Haxelib / Dependências
    # =========================
    - name: Install Haxelib Dependencies
      run: |
        haxelib setup ~/haxelib
        haxelib install hxcpp -y
        haxelib install lime 7.9.0 -y
        haxelib install openfl 9.1.0 -y
        haxelib install flixel -y
        haxelib install flixel-tools -y
        haxelib install flixel-ui -y
        haxelib install flixel-addons -y
        haxelib install hscript -y
        haxelib install hxp -y
        haxelib install hxCodec -y
        haxelib git discord_rpc https://github.com/Aidan63/linc_discord-rpc
        haxelib git flxanimate https://github.com/Dot-Stuff/flxanimate
        haxelib git linc_luajit https://github.com/MAJigsaw77/linc_luajit
        haxelib git extension-webview https://github.com/MatheusSilver/extension-webview --quiet
        haxelib git extension-videoview https://github.com/MAJigsaw77/extension-videoview --quiet
        haxelib git extension-androidtools https://github.com/MAJigsaw77/extension-androidtools
        haxelib list

    # =========================
    # Lime Setup
    # =========================
    - name: Configure Lime
      run: |
        haxelib run lime setup -y
        haxelib run lime config ANDROID_SDK $ANDROID_HOME
        haxelib run lime config ANDROID_NDK_ROOT $ANDROID_NDK_HOME
        haxelib run lime config JAVA_HOME $JAVA_HOME
        haxelib set lime 7.9.0
        haxelib set openfl 9.1.0
        haxelib list
      env:
        ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

    # =========================
    # Build APK
    # =========================
    - name: Build Android APK
      run: |
        haxelib run lime build android -debug --app-version="2025.12.${{ github.run_id }}"

    # =========================
    # Upload APK (Artifact)
    # =========================
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: FNF-Android-APK
        path: |
          export/release/android/bin/app/build/outputs/apk/debug/*.apk
