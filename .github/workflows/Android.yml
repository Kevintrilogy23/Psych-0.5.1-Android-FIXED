name: Build Android Psych Engine (Stable 2025)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  buildAndroid:
    runs-on: ubuntu-latest

    env:
      ANDROID_API_LEVEL: 34
      ANDROID_BUILD_TOOLS: "34.0.0"
      NDK_VERSION: r21e

    steps:
    # ============================
    # CHECKOUT
    # ============================
    - name: Checkout
      uses: actions/checkout@v4

    # ============================
    # JAVA (OBRIGATÓRIO JDK 17)
    # ============================
    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    # ============================
    # ANDROID SDK (ATUAL)
    # ============================
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        packages: >-
          cmdline-tools;latest,
          platform-tools,
          platforms;android-34,
          build-tools;34.0.0

    # ============================
    # ANDROID NDK (COMPATÍVEL HXCPP)
    # ============================
    - name: Setup Android NDK
      id: setup-ndk
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r21e

    # ============================
    # HAXE
    # ============================
    - name: Setup Haxe
      uses: krdlab/setup-haxe@v1
      with:
        haxe-version: 4.2.5

    # ============================
    # HAXELIB DEPENDÊNCIAS
    # ============================
    - name: Install Haxelib Dependencies
      run: |
        set -e
        haxelib setup ~/haxelib
        haxelib install hxcpp -y
        haxelib install lime 7.9.0 -y
        haxelib install openfl 9.1.0 -y
        haxelib install flixel -y
        haxelib install flixel-tools -y
        haxelib install flixel-ui -y
        haxelib install flixel-addons -y
        haxelib install hscript -y
        haxelib install hxp -y
        haxelib install hxCodec -y

        # libs usadas em Psych Engine / ports
        haxelib git discord_rpc https://github.com/Aidan63/linc_discord-rpc || true
        haxelib git flxanimate https://github.com/Dot-Stuff/flxanimate || true
        haxelib git linc_luajit https://github.com/MAJigsaw77/linc_luajit || true
        haxelib git extension-webview https://github.com/MatheusSilver/extension-webview || true
        haxelib git extension-videoview https://github.com/MAJigsaw77/extension-videoview || true
        haxelib git extension-androidtools https://github.com/MAJigsaw77/extension-androidtools || true

        haxelib list

    # ============================
    # CONFIGURAR LIME
    # ============================
    - name: Configure Lime
      run: |
        haxelib run lime setup -y
        haxelib run lime config ANDROID_SDK $ANDROID_HOME
        haxelib run lime config ANDROID_NDK_ROOT $ANDROID_NDK_HOME
        haxelib run lime config JAVA_HOME $JAVA_HOME
        haxelib set lime 7.9.0
        haxelib set openfl 9.1.0
        haxelib list
      env:
        ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

    # ============================
    # BUILD APK
    # ============================
    - name: Build Android APK
      run: |
        haxelib run lime build android -debug --app-version="2025.12.${{ github.run_id }}"
      env:
        ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

    # ============================
    # UPLOAD APK (NÃO DEPRECIADO)
    # ============================
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: PsychEngine-Android-APK
        path: |
          export/release/android/bin/app/build/outputs/apk/debug/*.apk        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

      # --- Optional: show Java + sdkmanager versions to debug quickly
      - name: Diagnostic: Java + sdkmanager
        run: |
          java -version || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --version || true
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}

      # --- Build command (ajuste flags conforme seu projeto)
      - name: Build Android APK (debug)
        run: |
          set -e
          # use debug build (mais simples). Para release, trate assinatura.
          haxelib run lime build android -debug --app-version="2025.12.${{ github.run_id }}"
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

      # --- Upload artifact (APK)
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: FNF-Android-APK
          path: |
            export/release/android/bin/app/build/outputs/apk/debug/*.apk
